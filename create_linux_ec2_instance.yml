---
  - name: Create ec2 instance
    hosts: local
    connection: local

    tasks:
      - name: Create New EC2 Instance
        amazon.aws.ec2_instance:
          name: "web app 1"
          instance_type: t2.micro
          image_id: ami-078a289ddf4b09ae0
          key_name: web_app_ec2_key
          region: eu-west-2
          count: 1
          network:
            assign_public_ip: yes
            security_group: default
            vpc_subnet_id: subnet-07502af8e09a5ed7a
          state: present
          tags:
            Env: "dev"
            Management: "Ansible"


  - name: Create ec2 keypair
    hosts: local
    connection: local

    tasks:
      - name: Create new keypair
        amazon.aws.ec2_key:
          name: web_app_ec2_key
          region: eu-west-2
          tags:
            Env: "dev"
            Managment: "Ansible"
          state: present
        register: ec2_key_result


      - name: Save private keypair
        copy: content="{{ ec2_key_result.key.private_key }}" dest="./aws.webapp1.pem" mode=600
        when: ec2_key_result.changed  
